name: Build A32 Vampire Kernel (SukiSU + RKSU)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: valerynx/vampire_samsung_a32
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev flex bison bc git cpio unzip python3 python3-pip xz-utils libssl-dev

      - name: Setup Zyc Clang 14
        run: |
          mkdir -p $HOME/zyc-clang
          cd $HOME/zyc-clang
          wget https://github.com/EmanuelCN/zyc_clang-14/archive/refs/heads/master.zip
          unzip master.zip
          # Move files so the 'bin' folder is exactly at $HOME/zyc-clang/bin
          mv zyc_clang-14-master/* . || mv zyc_clang-14-main/* .
          chmod +x bin/*

      - name: Build Kernel
        env:
          # Define the absolute path to your toolchain
          TC_PATH: ${{ github.workspace }}/../zyc-clang/bin
        run: |
          mkdir -p out
          
          # We define the tools using the absolute path to prevent "not found" errors
          MAKE_ARGS="O=out \
                ARCH=arm64 \
                CC=${{ env.TC_PATH }}/clang \
                LD=${{ env.TC_PATH }}/ld.lld \
                AR=${{ env.TC_PATH }}/llvm-ar \
                NM=${{ env.TC_PATH }}/llvm-nm \
                OBJCOPY=${{ env.TC_PATH }}/llvm-objcopy \
                OBJDUMP=${{ env.TC_PATH }}/llvm-objdump \
                STRIP=${{ env.TC_PATH }}/llvm-strip \
                READELF=${{ env.TC_PATH }}/llvm-readelf \
                CLANG_TRIPLE=aarch64-linux-gnu- \
                CROSS_COMPILE=${{ env.TC_PATH }}/aarch64-linux-gnu- \
                CROSS_COMPILE_ARM32=${{ env.TC_PATH }}/arm-linux-gnueabi- \
                KCFLAGS='-w -pipe -O3' \
                CONFIG_SECTION_MISMATCH_WARN_ONLY=y"

          # 1. Configure
          make $MAKE_ARGS a32_k+e_defconfig
          
          # 2. Force KSU/RKSU configs
          scripts/config --file out/.config -e CONFIG_KSU
          scripts/config --file out/.config -e CONFIG_KSU_SUSFS
          scripts/config --file out/.config -e CONFIG_RKSU
          scripts/config --file out/.config -e CONFIG_RKSU_MANUAL_HOOK
          
          # 3. Build
          make $MAKE_ARGS olddefconfig
          make -j$(nproc --all) $MAKE_ARGS
          
          echo "KERNEL_VERSION=$(make -C out kernelversion)" >> $GITHUB_ENV
      - name: Setup SukiSU Ultra
        run: |
          curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -s builtin

      - name: Apply RKSU Manual Hook
        run: |
          wget https://raw.githubusercontent.com/rksuorg/kernel_patches/refs/heads/master/manual_hook/kernel-4.14.patch
          patch -p1 < kernel-4.14.patch || echo "RKSU Patch had some offsets, checking manual application..."

      - name: Apply Sys_Reboot Hook
        run: |
          wget https://raw.githubusercontent.com/valerynx/action/refs/heads/main/sys_reboot.diff
          patch -p1 < sys_reboot.diff || echo "Reboot patch failed, check compatibility."

      - name: Configure and Enforce Defconfig
        run: |
          # Use your specific defconfig
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- a32_manual_ksu_defconfig
          
          # Force enforcement of KSU and RKSU configurations
          scripts/config -e CONFIG_KSU
          scripts/config -e CONFIG_KSU_SUSFS
          scripts/config -e CONFIG_RKSU
          scripts/config -e CONFIG_RKSU_MANUAL_HOOK
          scripts/config -e CONFIG_OVERLAY_FS
          scripts/config -e CONFIG_KPROBES
          
          # Finalize config
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

      - name: Build Kernel
        run: |
          # 1. Setup paths and output dir
          mkdir -p out
          TC_DIR="$HOME/zyc-clang/bin"
          
          # 2. Export variables to prevent shell parsing errors
          export ARCH=arm64
          export CC="$TC_DIR/clang"
          export LD="$TC_DIR/ld.lld"
          export AR="$TC_DIR/llvm-ar"
          export NM="$TC_DIR/llvm-nm"
          export OBJCOPY="$TC_DIR/llvm-objcopy"
          export OBJDUMP="$TC_DIR/llvm-objdump"
          export STRIP="$TC_DIR/llvm-strip"
          export READELF="$TC_DIR/llvm-readelf"
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export CROSS_COMPILE="$TC_DIR/aarch64-linux-gnu-"
          export CROSS_COMPILE_ARM32="$TC_DIR/arm-linux-gnueabi-"
          export KCFLAGS="-w -pipe -O3"
          export KCPPFLAGS="-O3"
          export CONFIG_SECTION_MISMATCH_WARN_ONLY=y

          # 3. Step 1: Configuration
          echo "--- Generating Config ---"
          make O=out a32_k+e_defconfig

          # 4. Step 2: Inject KSU/RKSU
          echo "--- Patching .config ---"
          ./scripts/config --file out/.config -e CONFIG_KSU
          ./scripts/config --file out/.config -e CONFIG_KSU_SUSFS
          ./scripts/config --file out/.config -e CONFIG_RKSU
          ./scripts/config --file out/.config -e CONFIG_RKSU_MANUAL_HOOK
          
          # 5. Step 3: Build the Kernel
          echo "--- Starting Build ---"
          make O=out -j$(nproc --all) olddefconfig
          make O=out -j$(nproc --all)

          # 6. Extract version for Telegram
          echo "KERNEL_VERSION=$(make -C out ARCH=arm64 kernelversion)" >> $GITHUB_ENV
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vampire@ncatt
          path: |
            arch/arm64/boot/Image
