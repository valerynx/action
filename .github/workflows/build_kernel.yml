name: Build A32 Vampire Kernel (SukiSU + RKSU)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: valerynx/vampire_samsung_a32
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses-dev flex bison bc git cpio unzip python3 python3-pip xz-utils
          pip install pyyaml

      - name: Setup Zyc Clang 14
        run: |
          mkdir zyc-clang
          cd zyc-clang
          wget https://github.com/EmanuelCN/zyc_clang-14/archive/refs/heads/main.zip
          unzip main.zip
          # Add the bin directory to path (adjusting for the repo structure)
          echo "$(pwd)/zyc_clang-14-main/bin" >> $GITHUB_PATH
          cd ..

      - name: Setup SukiSU Ultra
        run: |
          curl -LSs 'https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh' | bash -s builtin

      - name: Apply RKSU Manual Hook
        run: |
          wget https://raw.githubusercontent.com/rksuorg/kernel_patches/refs/heads/master/manual_hook/kernel-4.14.patch
          patch -p1 < kernel-4.14.patch || echo "RKSU Patch had some offsets, checking manual application..."

      - name: Apply Sys_Reboot Hook
        run: |
          wget https://raw.githubusercontent.com/valerynx/action/refs/heads/main/sys_reboot.diff
          patch -p1 < sys_reboot.diff || echo "Reboot patch failed, check compatibility."

      - name: Configure and Enforce Defconfig
        run: |
          # Use your specific defconfig
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- a32_manual_ksu_defconfig
          
          # Force enforcement of KSU and RKSU configurations
          scripts/config -e CONFIG_KSU
          scripts/config -e CONFIG_KSU_SUSFS
          scripts/config -e CONFIG_RKSU
          scripts/config -e CONFIG_RKSU_MANUAL_HOOK
          scripts/config -e CONFIG_OVERLAY_FS
          scripts/config -e CONFIG_KPROBES
          
          # Finalize config
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

      - name: Build Kernel
        run: |
          make -j$(nproc --all) \
               ARCH=arm64 \
               CC=clang \
               CLANG_TRIPLE=aarch64-linux-gnu- \
               CROSS_COMPILE=aarch64-linux-gnu- \
               CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
               LD=ld.lld \
               AR=llvm-ar \
               NM=llvm-nm \
               OBJCOPY=llvm-objcopy \
               OBJDUMP=llvm-objdump \
               STRIP=llvm-strip

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-A32-SukiSU-RKSU
          path: |
            arch/arm64/boot/Image
            arch/arm64/boot/Image.gz-dtb
            arch/arm64/boot/dtbo.img
